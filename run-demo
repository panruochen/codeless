#!/bin/bash

set -e

function executable_get()
{
	if [ -r make.exe ]; then
		echo make.exe
	else
		echo make
	fi
}

function prepare()
{
	if [ -d ${TARGET} ]; then
		rm -rf ${TARGET}/
	fi
	d=$(dirname  ${TARGET})
	f=$(basename ${TARGET})
	(	cd "$d"
		suffix=tar.bz2
		ft="$f-configured"
		if [ -f ${ft}.${suffix} ]; then
			f=${ft}
		fi
		tar xfj $f.${suffix}
	)
	HAVE_CONFIGURED=y
}

function step1()
{
	TIME=$(env LANG=en_US date)

	if [ x$HAVE_CONFIGURED != xy ]; then
		./configure
	fi
	HAVE_CONFIGURED=y
	make
	yMAKE=$(executable_get)
	objcopy -O binary $yMAKE yy-1.bin
	objdump -d $yMAKE > yy-1.asm
}

function step2()
{
	make clean
	../../y-Make --yz-cc=gcc --yz-save-command-line=commands.txt --yz-shell=bash -j1 --yz-bypass=ar.c --yz-bypass=dir.c
	yMAKE=$(executable_get)
	objcopy -O binary $yMAKE yy-2.bin
	objdump -d $yMAKE > yy-2.asm
}

#--------------------------------------------------------------------#
#
#
#--------------------------------------------------------------------#
PACKAGE=make-3.81
#PACKAGE=util-linux-2.20
TARGET=testsuites/${PACKAGE}

prepare
cd ${TARGET}
step1
step2

